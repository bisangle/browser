# Chrome exploit: V8 properties + P2PHostMsg_Send

> Reported by aedla@chromium.org, Sep 22 2014

## VULNERABILITY DETAILS

See `writeup.pdf`. (follow link in the tracker)

### V8 slow / fast properties confusion

Code in `src/objects.cc:4089`:
``` cpp
MaybeHandle<Object> JSObject::SetOwnPropertyIgnoreAttributes(
..
object­>LookupOwn(name, &lookup, true);
..
if (is_observed && lookup.IsProperty()) {
if (lookup.IsDataProperty()) {
old_value = Object::GetPropertyOrElement(object, name).ToHandleChecked();
}
old_attributes = lookup.GetAttributes();
}
..
switch (lookup.type()) {
case NORMAL:
ReplaceSlowProperty(object, name, value, attributes);
```

`GetPropertyOrElement()` can invoke a getter. The getter can transform object to fast properties, confusing `ReplaceSlowProperty()` into corrupting memory. The `lookup.IsDataProperty()` actually checks whether name is a getter. And it takes some trickery to get past that. See `writeup.pdf`.

This bug was fixed by refactoring on August 18, but still impacts current stable and beta. I got the renderer arbitrary R/W to work on Android and 64-bit linux. I think it should work on Windows as well.

### P2PHostMsg_Send OOB write

content/browser/renderer_host/p2p/socket_dispatcher_host.cc:269:
``` cpp
void P2PSocketDispatcherHost::OnSend(int socket_id,
...
const rtc::PacketOptions& options,

content/browser/renderer_host/p2p/socket_host.cc:131:
void UpdateRtpAuthTag(char* rtp, int len,
const rtc::PacketOptions& options) {
...
size_t tag_length = options.packet_time_params.srtp_auth_tag_len;
char* auth_tag = rtp + (len ­ tag_length);
...
if (hmac.DigestLength() < tag_length) {
NOTREACHED();
return;
}
...
memcpy(auth_tag, &options.packet_time_params.srtp_packet_index, 4);
...
memcpy(auth_tag, output, tag_length);
```

The `srtp_auth_tag_len` field is renderer-controlled and lacks validation. The first memcpy OOB writes 4 bytes if `srtp_auth_tag_len == 0`. `socket_host.cc` also has a bunch of other issues. See `writeup.pdf`.

## VERSION

37.0.2062.120 stable
38.0.2125.66 beta

Operating System:
Renderer R/W: all
Sandbox break: 64-bit linux

## REPRODUCTION CASE

- run ./webserver inside v8p2p/
- navigate to http://localhost:8000/v8p2p/v8p2p.html
- /etc/passwd is displayed

Link: https://bugs.chromium.org/p/chromium/issues/detail?id=416449
